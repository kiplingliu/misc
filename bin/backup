#!/bin/bash

REMOTE="mega"
NOTES_DIR="$HOME/Notes"
NOTES_BUNDLE="$HOME/Notes.bundle"

DRY_RUN=0
while getopts "n" opt; do
    case "$opt" in
        n)
            DRY_RUN=1
            ;;
        *)
            ;;
    esac
done

if [[ $DRY_RUN -ne 1 ]]; then
    (
        REPO_PATH="$NOTES_DIR"
        CURRENT_DATE=$(date +"%Y-%m-%d")

        cd "$NOTES_DIR" || exit 1
        if [[ -n "$(git status --porcelain)" ]]; then
            echo "Changes detected in $REPO_PATH. Performing commit for $CURRENT_DATE..."

            git add .
            git commit --author="Laptop Bot <bot@localhost>" -m "Automated snapshot"

            git bundle create "$NOTES_BUNDLE" --all
        fi
    )
fi

BACKUP_PATHS=(
    "$(xdg-user-dir DESKTOP)"
    "$(xdg-user-dir DOCUMENTS)"
    "$NOTES_BUNDLE"
)

for P in "${BACKUP_PATHS[@]}"
do
    if [[ -r "$P" ]]
    then
        echo "Backing up $P"
        rclone sync "$@" "$P" "$REMOTE:${P##*/}"
    else
        echo "$P doesn't exist; not backed up"
    fi
done
